<html>
<head>
    <title>WebRTC Data Channel Echo Server Example</title>
    <script>
        let SERVER_SOCKET_ADDRESS = "192.168.1.5:3179";
        let SERVER_URL = "http://" + SERVER_SOCKET_ADDRESS + "/new_rtc_session";
        let PING_MSG = "ping";
        let PONG_MSG = "pong";

        let peer = new RTCPeerConnection({
            iceServers: [{
                urls: ["stun:stun.l.google.com:19302"]
            }]
        });
        //This is how you close the data channel: `peer.close();`

        let channel = peer.createDataChannel("webudp", {
            ordered: false,
            maxRetransmits: 0
        });
        channel.binaryType = "arraybuffer";

        console.log("WebRTC Client initialized");

        channel.onopen = function() {
            console.log("Client connected to: " + SERVER_SOCKET_ADDRESS);

            channel.send(PING_MSG);

            channel.onmessage = function(evt) {
                console.log("Client recv: " + evt.data);

                if (evt.data === PONG_MSG) {
                    setTimeout(() => {
                        let message = PING_MSG;
                        console.log("Client send: " + message);
                        channel.send(message);
                    }, 1000);
                }
            };
        };

        channel.onerror = function(evt) {
            console.log("Client data channel error:", evt.message);
        };

        peer.onicecandidate = function(evt) {
            if (evt.candidate) {
                console.log("Client received ice candidate: ", evt.candidate);
            } else {
                console.log("Client received all local candidates");
            }
        };

        peer.createOffer().then(function(offer) {
            return peer.setLocalDescription(offer);
        }).then(function() {
            var request = new XMLHttpRequest();
            request.open("POST", SERVER_URL);
            request.onload = function() {
                if (request.status == 200) {
                    var response = JSON.parse(request.responseText);
                    peer.setRemoteDescription(new RTCSessionDescription(response.answer)).then(function() {
                        var candidate = new RTCIceCandidate(response.candidate);
                        peer.addIceCandidate(candidate).then(function() {
                            console.log("Client add ice candidate success");
                        }).catch(function(err) {
                            console.log("Client error during 'addIceCandidate':", err);
                        });
                    }).catch(function(e) {
                        console.log("Client error during 'setRemoteDescription':", e);
                    });
                }
            };
            request.send(peer.localDescription.sdp);
        }).catch(function(reason) {
            console.log("Client error during 'createOffer':", reason);
        });
    </script>
</head>
<body></body>
</html>
